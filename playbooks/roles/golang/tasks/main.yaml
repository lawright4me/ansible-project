---
- name: Ensure temporary directory exists
  ansible.builtin.file:
    path: /tmp/go-install
    state: directory
    mode: "0755"

- name: Download Go archive
  ansible.builtin.get_url:
    url: "{{ go_archive_url }}"
    dest: "/tmp/go-install/go{{ go_version }}.tar.gz"
    checksum: "{{ go_checksum | default(omit) }}"
    timeout: 30
  register: go_download
  until: go_download is succeeded
  retries: 3
  delay: 5

- name: Remove existing Go installation
  ansible.builtin.file:
    path: "{{ go_install_dir }}/go"
    state: absent

- name: Extract Go archive
  ansible.builtin.unarchive:
    src: "/tmp/go-install/go{{ go_version }}.tar.gz"
    dest: "{{ go_install_dir }}"
    remote_src: yes
    extra_opts: ["--strip-components=1"]
    creates: "{{ go_install_dir }}/go"

- name: Create Go workspace directories
  ansible.builtin.file:
    path: "{{ go_workspace_dir }}/{{ item }}"
    state: directory
    owner: "{{ ansible_facts.user_id | default(ansible_user | default('root')) }}"
    group: "{{ ansible_facts.group_id | default(ansible_user | default('root')) }}"
    mode: "0755"
  loop:
    - "src"
    - "pkg"
    - "bin"

- name: Set up environment variables in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    line: |
      export PATH="$PATH:{{ go_install_dir }}/go/bin:{{ go_workspace_dir }}/bin"
      export GOPATH="{{ go_workspace_dir }}"
      export GOROOT="{{ go_install_dir }}/go"
    create: yes
  when: ansible_os_family == "Debian" or ansible_os_family == "RedHat"

- name: Source .bashrc to apply changes
  ansible.builtin.shell: source {{ ansible_user_dir }}/.bashrc
  args:
    executable: /bin/bash
  changed_when: false

- name: Verify Go installation
  ansible.builtin.command: go version
  register: go_version_result
  changed_when: false

- name: Display Go version
  ansible.builtin.debug:
    var: go_version_result.stdout

